# 谷粒商城笔记 2022年6月26日16:48:56

# common模块

> 统一公共依赖和工具类

# Nacos

## ## application.yml

```java
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
  application:
    name: gulimall-coupon
```

## Fegin远程调用

### 调用方

#### pom

```java
       <!--远程调用端-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
        </dependency>
       <!--需要在引用common中 排除掉ribbon-->
         <dependency>
            <groupId>com.pc.gulimall</groupId>
            <artifactId>gulimall-common</artifactId>
            <exclusions>
                <!-- 将ribbon排除 -->
                <exclusion>
                    <groupId>org.springframework.cloud</groupId>
                    <artifactId>spring-cloud-starter-netflix-ribbon</artifactId>
                </exclusion>
            </exclusions>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
```

#### 使用

* ##### 启动类上开启
  
  ```java
  @EnableDiscoveryClient
  @EnableFeignClients("com.pc.gulimall.member.feign")
  ```

* ##### 创建接口
  
  ```java
  @FeignClient("gulimall-coupon")
  public interface CoupomService {
  
      @RequestMapping("/coupon/coupon/member/list")
      public R memberCoupon();
  }
  ```

* ##### controller中调用
  
  > 和平常接口无区别

#### 被调用方

##### pom

```java
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
```

#### 使用

> 任意controller，调用方指明方法具体路径即可

#### 启动类上

```java
@EnableDiscoveryClient
```

## 统一网关

> 配置网关，统一路由转发规则并解决跨域问题，方便整体的管理

### 构建网关

> 将前端所有的请求发送到网关的端口

#### 网关配置

> 启动类上需要用@EnableDiscoveryClient 开启nacos发现服务
> 
> 基础配置类配置好所需nacos参数
> 
> 设置路由规则

```java
spring:
  cloud:
    gateway:
      routes:
        # 唯一id标识
        - id: product_route
        # 需要发送到的服务
          uri: lb://gulimall-product
         # 拦截规则
          predicates:
            - Path=/api/product/**
         # 过滤重写路径 
          filters:
            - RewritePath=/api/(?<segment>.*), /$\{segment}
```

#### 跨域解决

```java
@Configuration
public class GulimallCorsConfiguration {

    @Bean
    public CorsWebFilter corsWebFilter(){
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();

        CorsConfiguration corsConfiguration = new CorsConfiguration();

        //1、配置跨域
        corsConfiguration.addAllowedHeader("*");
        corsConfiguration.addAllowedMethod("*");
        corsConfiguration.addAllowedOrigin("*");
        corsConfiguration.setAllowCredentials(true);

        source.registerCorsConfiguration("/**",corsConfiguration);
        return new CorsWebFilter(source);
    }
}
```

# ElasticSearch

> https://www.elastic.co/guide/en/elasticsearch/client/java-api/current/java-search.html
